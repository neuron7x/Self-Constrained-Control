# Security Policy Verification Workflow
# This workflow runs security policy checks and validates security configurations.

name: "Security Policy Check"

on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - '.github/dependabot.yml'
      - 'requirements*.txt'
      - 'pyproject.toml'
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - '.github/dependabot.yml'
      - 'requirements*.txt'
      - 'pyproject.toml'
  schedule:
    # Run weekly security policy check on Sunday at 01:00 UTC
    - cron: "0 1 * * 0"
  workflow_dispatch:

# Principle of least privilege
permissions:
  contents: read
  security-events: read

jobs:
  verify-action-pinning:
    name: Verify Action SHA Pinning
    runs-on: ubuntu-latest
    # Security: Do not run on forks
    if: github.event.pull_request.head.repo.fork == false || github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for unpinned actions
        run: |
          set -euo pipefail
          echo "üîç Checking for unpinned GitHub Actions..."
          
          UNPINNED_ACTIONS=0
          
          # Find all workflow files
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "Checking: $workflow"
              
              # Check for uses: statements without SHA pinning
              # Pattern: uses: owner/action@ref (where ref is NOT a 40-char hex SHA)
              while IFS= read -r line; do
                # Skip comments
                if echo "$line" | grep -q '^\s*#'; then
                  continue
                fi
                
                # Check if line contains 'uses:' with an action reference
                if echo "$line" | grep -qE 'uses:\s+[^@]+@'; then
                  # Extract the reference after @ (handles tags, branches, and SHAs)
                  REF=$(echo "$line" | grep -oE '@[a-zA-Z0-9._/-]+' | tail -1 | sed 's/@//')
                  if [ -n "$REF" ]; then
                    # Check if REF is a 40-character hex string (SHA) - case insensitive
                    if ! echo "$REF" | grep -qiE '^[a-f0-9]{40}$'; then
                      echo "‚ö†Ô∏è  Unpinned action found: $line"
                      UNPINNED_ACTIONS=$((UNPINNED_ACTIONS + 1))
                    fi
                  fi
                fi
              done < "$workflow"
            fi
          done
          
          if [ $UNPINNED_ACTIONS -gt 0 ]; then
            echo ""
            echo "‚ùå Found $UNPINNED_ACTIONS unpinned action(s)!"
            echo "All actions should be pinned to full commit SHA for security."
            echo "Example: uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683"
            exit 1
          else
            echo ""
            echo "‚úÖ All actions are properly pinned to commit SHAs!"
          fi

  verify-permissions:
    name: Verify Workflow Permissions
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.fork == false || github.event_name != 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Check for overly permissive workflows
        run: |
          set -euo pipefail
          echo "üîç Checking workflow permissions..."
          
          ISSUES=0
          
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$workflow" ]; then
              echo "Checking: $workflow"
              
              # Check for 'permissions: write-all' or no permissions block
              if grep -qE '^\s*permissions:\s*write-all' "$workflow"; then
                echo "‚ö†Ô∏è  Overly permissive 'write-all' found in: $workflow"
                ISSUES=$((ISSUES + 1))
              fi
            fi
          done
          
          if [ $ISSUES -gt 0 ]; then
            echo ""
            echo "‚ùå Found $ISSUES workflow(s) with security issues!"
            exit 1
          else
            echo ""
            echo "‚úÖ Workflow permissions are properly configured!"
          fi
